{"version":3,"file":"VMaskInput.js","names":["makeVTextFieldProps","VTextField","forwardRefs","isMaskDelimiter","makeMaskProps","useMask","useProxiedModel","computed","nextTick","onBeforeMount","ref","shallowRef","toRef","genericComponent","propsFactory","useRender","makeVMaskInputProps","returnMaskedValue","Boolean","VMaskInput","name","props","emits","val","setup","slots","emit","vTextFieldRef","inputAction","caretPosition","mask","model","undefined","unmask","valueWithoutDelimiters","removeMaskDelimiters","newMaskedValue","newUnmaskedValue","newCaretPosition","getNewCaretPosition","oldValue","value","newValue","oldCaret","setSelectionRange","validationValue","split","filter","ch","join","length","newCaret","onKeyDown","e","metaKey","inputElement","target","selectionStart","key","hasSelection","selectionEnd","preventDefault","deleteSelection","onCut","copySelectionToClipboard","onPaste","pastedString","clipboardData","getData","pastedCharacters","replaceSelection","insertCharacters","start","end","selectedText","substring","navigator","clipboard","writeText","curStart","success","simulateBackspace","slice","i","insertCharacter","character","replaceCharacter","index","targetIndex","textFieldProps","filterProps","_createVNode","_mergeProps","$event","class","style"],"sources":["../../../src/labs/VMaskInput/VMaskInput.tsx"],"sourcesContent":["// Components\nimport { makeVTextFieldProps, VTextField } from '@/components/VTextField/VTextField'\n\n// Composables\nimport { forwardRefs } from '@/composables/forwardRefs'\nimport { isMaskDelimiter, makeMaskProps, useMask } from '@/composables/mask'\nimport { useProxiedModel } from '@/composables/proxiedModel'\n\n// Utilities\nimport { computed, nextTick, onBeforeMount, ref, shallowRef, toRef } from 'vue'\nimport { genericComponent, propsFactory, useRender } from '@/util'\n\n// Types\nimport type { VTextFieldSlots } from '@/components/VTextField/VTextField'\n\nexport type VMaskInputSlots = VTextFieldSlots\n\nexport const makeVMaskInputProps = propsFactory({\n  returnMaskedValue: Boolean,\n  ...makeVTextFieldProps(),\n  ...makeMaskProps(),\n}, 'VMaskInput')\n\nexport const VMaskInput = genericComponent<VMaskInputSlots>()({\n  name: 'VMaskInput',\n\n  props: makeVMaskInputProps(),\n\n  emits: {\n    'update:modelValue': (val: string) => true,\n  },\n\n  setup (props, { slots, emit }) {\n    const vTextFieldRef = ref<VTextField>()\n\n    const inputAction = shallowRef()\n    const caretPosition = shallowRef(0)\n\n    const mask = useMask(props)\n    const returnMaskedValue = computed(() => props.mask && props.returnMaskedValue)\n\n    const model = useProxiedModel(\n      props,\n      'modelValue',\n      undefined,\n      // Always display masked value in input when mask is applied\n      val => props.mask ? mask.mask(mask.unmask(val)) : val,\n      val => {\n        if (props.mask) {\n          const valueWithoutDelimiters = val ? removeMaskDelimiters(val) : ''\n\n          // E.g. mask is #-# and the input value is '2-23'\n          // model-value should be enforced to '2-2'\n          const newMaskedValue = mask.mask(valueWithoutDelimiters)\n          const newUnmaskedValue = mask.unmask(newMaskedValue)\n\n          const newCaretPosition = getNewCaretPosition({\n            oldValue: model.value,\n            newValue: newMaskedValue,\n            oldCaret: caretPosition.value,\n          })\n\n          vTextFieldRef.value!.value = newMaskedValue\n          vTextFieldRef.value!.setSelectionRange(newCaretPosition, newCaretPosition)\n\n          return returnMaskedValue.value ? mask.mask(newUnmaskedValue) : newUnmaskedValue\n        }\n        return val\n      },\n    )\n\n    const validationValue = toRef(() => returnMaskedValue.value ? model.value : mask.unmask(model.value))\n\n    function removeMaskDelimiters (val: string): string {\n      return val.split('').filter(ch => !isMaskDelimiter(ch)).join('')\n    }\n\n    function getNewCaretPosition ({\n      oldValue,\n      newValue,\n      oldCaret,\n    }: {\n      oldValue: string\n      newValue: string\n      oldCaret: number\n    }): number {\n      if (!newValue) return 0\n      if (!oldValue) return newValue.length\n\n      let newCaret: number\n\n      if (inputAction.value === 'Backspace') {\n        newCaret = oldCaret - 1\n        while (newCaret > 0 && isMaskDelimiter(newValue[newCaret - 1])) newCaret--\n      } else if (inputAction.value === 'Delete') {\n        newCaret = oldCaret\n      } else { // insertion\n        newCaret = oldCaret + 1\n        while (isMaskDelimiter(newValue[newCaret])) newCaret++\n        if (isMaskDelimiter(newValue[oldCaret])) newCaret++\n      }\n\n      return newCaret\n    }\n\n    onBeforeMount(() => {\n      if (props.returnMaskedValue) {\n        emit('update:modelValue', model.value)\n      }\n    })\n\n    function onKeyDown (e: KeyboardEvent) {\n      if (e.metaKey) return\n\n      const inputElement = e.target as HTMLInputElement\n\n      caretPosition.value = inputElement.selectionStart || 0\n      inputAction.value = e.key\n\n      const hasSelection = inputElement.selectionStart !== inputElement.selectionEnd\n      if (e.key === 'Backspace' && hasSelection) {\n        e.preventDefault()\n        deleteSelection(e)\n      }\n    }\n\n    async function onCut (e: Event) {\n      e.preventDefault()\n\n      await copySelectionToClipboard(e)\n      await deleteSelection(e)\n    }\n\n    async function onPaste (e: ClipboardEvent) {\n      e.preventDefault()\n\n      const inputElement = e.target as HTMLInputElement\n      const pastedString = removeMaskDelimiters(e.clipboardData?.getData('text') || '')\n\n      if (!pastedString) return\n\n      const pastedCharacters = [...pastedString]\n\n      const hasSelection = inputElement.selectionStart !== inputElement.selectionEnd\n\n      if (hasSelection) {\n        replaceSelection(inputElement, pastedCharacters)\n      } else {\n        insertCharacters(inputElement, pastedCharacters)\n      }\n    }\n\n    async function copySelectionToClipboard (e: Event) {\n      const inputElement = e.target as HTMLInputElement\n      const start = inputElement.selectionStart || 0\n      const end = inputElement.selectionEnd || 0\n      const selectedText = inputElement.value.substring(start, end)\n      await navigator.clipboard.writeText(selectedText)\n    }\n\n    async function deleteSelection (e: Event) {\n      const inputElement = e.target as HTMLInputElement\n      const curStart = inputElement.selectionStart || 0\n      caretPosition.value = inputElement.selectionEnd || 0\n\n      while (caretPosition.value > curStart) {\n        const success = await simulateBackspace(inputElement)\n        if (!success) break\n      }\n    }\n\n    async function simulateBackspace (inputElement: HTMLInputElement) {\n      inputAction.value = 'Backspace'\n      model.value = inputElement.value.slice(0, caretPosition.value - 1) + inputElement.value.slice(caretPosition.value)\n      inputAction.value = ''\n      if (caretPosition.value === inputElement.selectionEnd) return false\n      caretPosition.value = inputElement.selectionEnd || 0\n      await nextTick()\n      return true\n    }\n\n    async function insertCharacters (inputElement: HTMLInputElement, pastedCharacters: string[]) {\n      for (let i = 0; i < pastedCharacters.length; i++) {\n        await insertCharacter(inputElement, pastedCharacters[i])\n      }\n    }\n\n    async function insertCharacter (inputElement: HTMLInputElement, character: string) {\n      caretPosition.value = inputElement.selectionEnd || 0\n      model.value = inputElement.value.slice(0, caretPosition.value) + character + inputElement.value.slice(caretPosition.value)\n      await nextTick()\n    }\n\n    async function replaceSelection (inputElement: HTMLInputElement, pastedCharacters: string[]) {\n      caretPosition.value = inputElement.selectionStart || 0\n      for (let i = 0; i < pastedCharacters.length; i++) {\n        await replaceCharacter(caretPosition.value, pastedCharacters[i])\n        caretPosition.value++\n      }\n    }\n\n    async function replaceCharacter (index: number, character: string) {\n      let targetIndex = index\n\n      // Find next non-delimiter position\n      while (targetIndex < model.value.length && isMaskDelimiter(model.value[targetIndex])) targetIndex++\n\n      model.value = model.value.slice(0, targetIndex) + character + model.value.slice(targetIndex + 1)\n      await nextTick()\n    }\n\n    useRender(() => {\n      const textFieldProps = VTextField.filterProps(props)\n\n      return (\n        <VTextField\n          { ...textFieldProps }\n          v-model={ model.value }\n          ref={ vTextFieldRef }\n          class={['v-mask-input', props.class]}\n          style={ props.style }\n          validationValue={ validationValue.value }\n          onCut={ onCut }\n          onPaste={ onPaste }\n          onKeydown={ onKeyDown }\n        >\n          {{ ...slots }}\n        </VTextField>\n      )\n    })\n\n    return forwardRefs({}, vTextFieldRef)\n  },\n})\n\nexport type VMaskInput = InstanceType<typeof VMaskInput>\n"],"mappings":"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","ignoreList":[]}