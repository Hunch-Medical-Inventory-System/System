{"version":3,"file":"focusTrap.js","names":["nextTick","onScopeDispose","toRef","toValue","watch","focusableChildren","IN_BROWSER","propsFactory","makeFocusTrapProps","retainFocus","Boolean","captureFocus","disableInitialFocus","registry","Map","subscribers","onKeydown","e","activeElement","document","key","parentTraps","Array","from","values","filter","isActive","contentEl","value","contains","map","x","closestTrap","currentParent","parentElement","includes","focusable","tabIndex","length","active","classList","preventDefault","firstElement","lastElement","shiftKey","focus","useFocusTrap","props","localTop","activatorEl","trapId","Symbol","focusTrapSuppressed","focusTrapSuppressionTimeout","onPointerdown","window","setTimeout","captureOnFocus","before","relatedTarget","after","target","removeEventListener","captureOnKeydown","allFocusableElements","documentElement","at","shouldCapture","val","set","delete","immediate","addEventListener","once","clearTimeout"],"sources":["../../src/composables/focusTrap.ts"],"sourcesContent":["// Utilities\nimport { nextTick, onScopeDispose, toRef, toValue, watch } from 'vue'\nimport { focusableChildren, IN_BROWSER, propsFactory } from '@/util'\n\n// Types\nimport type { Ref } from 'vue'\n\n// Types\nexport interface FocusTrapProps {\n  retainFocus: boolean\n  captureFocus: boolean\n  disableInitialFocus?: boolean\n}\n\n// Composables\nexport const makeFocusTrapProps = propsFactory({\n  retainFocus: Boolean,\n  captureFocus: Boolean,\n  /** @deprecated */\n  disableInitialFocus: Boolean,\n}, 'focusTrap')\n\nconst registry = new Map<symbol, {\n  isActive: Ref<boolean>\n  contentEl: Ref<HTMLElement | undefined>\n}>()\nlet subscribers = 0\n\nfunction onKeydown (e: KeyboardEvent) {\n  const activeElement = document.activeElement as HTMLElement | null\n  if (e.key !== 'Tab' || !activeElement) return\n\n  const parentTraps = Array.from(registry.values())\n    .filter(({ isActive, contentEl }) => isActive.value && contentEl.value?.contains(activeElement))\n    .map(x => x.contentEl.value)\n\n  let closestTrap\n  let currentParent = activeElement.parentElement\n  while (currentParent) {\n    if (parentTraps.includes(currentParent)) {\n      closestTrap = currentParent\n      break\n    }\n    currentParent = currentParent.parentElement\n  }\n\n  if (!closestTrap) return\n\n  const focusable = focusableChildren(closestTrap)\n    // excluding VListItems with tabindex=\"-2\"\n    .filter(x => x.tabIndex >= 0)\n\n  if (!focusable.length) return\n\n  const active = document.activeElement as HTMLElement | null\n  if (\n    focusable.length === 1 &&\n    focusable[0].classList.contains('v-list') &&\n    focusable[0].contains(active)\n  ) {\n    e.preventDefault()\n    return\n  }\n\n  const firstElement = focusable[0]\n  const lastElement = focusable[focusable.length - 1]\n\n  if (\n    e.shiftKey &&\n    (\n      active === firstElement ||\n      (firstElement.classList.contains('v-list') && firstElement.contains(active))\n    )\n  ) {\n    e.preventDefault()\n    lastElement.focus()\n  }\n\n  if (\n    !e.shiftKey &&\n    (\n      active === lastElement ||\n      (lastElement.classList.contains('v-list') && lastElement.contains(active))\n    )\n  ) {\n    e.preventDefault()\n    firstElement.focus()\n  }\n}\n\nexport function useFocusTrap (\n  props: FocusTrapProps,\n  { isActive, localTop, activatorEl, contentEl }: {\n    isActive: Ref<boolean>\n    localTop: Readonly<Ref<boolean>>\n    activatorEl?: Readonly<Ref<HTMLElement | undefined>>\n    contentEl: Readonly<Ref<HTMLElement | undefined>>\n  }\n) {\n  const trapId = Symbol('trap')\n\n  let focusTrapSuppressed = false\n  let focusTrapSuppressionTimeout = -1\n\n  async function onPointerdown () {\n    focusTrapSuppressed = true\n    focusTrapSuppressionTimeout = window.setTimeout(() => {\n      focusTrapSuppressed = false\n    }, 100)\n  }\n\n  async function captureOnFocus (e: FocusEvent) {\n    const before = e.relatedTarget as HTMLElement | null\n    const after = e.target as HTMLElement | null\n\n    document.removeEventListener('pointerdown', onPointerdown)\n    document.removeEventListener('keydown', captureOnKeydown)\n\n    await nextTick()\n\n    if (\n      isActive.value &&\n      !focusTrapSuppressed &&\n      before !== after &&\n      contentEl.value &&\n      // We're the menu without open submenus or overlays\n      toValue(localTop) &&\n      // It isn't the document or the container body\n      ![document, contentEl.value].includes(after!) &&\n      // It isn't inside the container body\n      !contentEl.value.contains(after)\n    ) {\n      const focusable = focusableChildren(contentEl.value)\n      focusable[0]?.focus()\n    }\n  }\n\n  function captureOnKeydown (e: KeyboardEvent) {\n    if (e.key !== 'Tab') return\n    document.removeEventListener('keydown', captureOnKeydown)\n\n    if (\n      isActive.value &&\n      contentEl.value &&\n      e.target &&\n      !contentEl.value.contains(e.target as Element)\n    ) {\n      const allFocusableElements = focusableChildren(document.documentElement)\n\n      if (\n        (e.shiftKey && e.target === allFocusableElements.at(0)) ||\n        (!e.shiftKey && e.target === allFocusableElements.at(-1))\n      ) {\n        const focusable = focusableChildren(contentEl.value)\n        if (focusable.length > 0) {\n          e.preventDefault()\n          focusable[0].focus()\n        }\n      }\n    }\n  }\n\n  const shouldCapture = toRef(() => isActive.value && props.captureFocus && !props.disableInitialFocus)\n\n  if (IN_BROWSER) {\n    watch(() => props.retainFocus, val => {\n      if (val) {\n        registry.set(trapId, { isActive, contentEl })\n      } else {\n        registry.delete(trapId)\n      }\n    }, { immediate: true })\n\n    watch(shouldCapture, val => {\n      if (val) {\n        document.addEventListener('pointerdown', onPointerdown)\n        document.addEventListener('focusin', captureOnFocus, { once: true })\n        document.addEventListener('keydown', captureOnKeydown)\n      } else {\n        document.removeEventListener('pointerdown', onPointerdown)\n        document.removeEventListener('focusin', captureOnFocus)\n        document.removeEventListener('keydown', captureOnKeydown)\n      }\n    }, { immediate: true })\n\n    if (subscribers++ < 1) {\n      document.addEventListener('keydown', onKeydown)\n    }\n  }\n\n  onScopeDispose(() => {\n    registry.delete(trapId)\n    clearTimeout(focusTrapSuppressionTimeout)\n    document.removeEventListener('pointerdown', onPointerdown)\n    document.removeEventListener('focusin', captureOnFocus)\n    document.removeEventListener('keydown', captureOnKeydown)\n\n    if (--subscribers < 1) {\n      document.removeEventListener('keydown', onKeydown)\n    }\n  })\n}\n"],"mappings":"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","ignoreList":[]}